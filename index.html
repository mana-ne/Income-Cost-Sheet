<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Household Income & Cost Sheet (Shared)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- React 18 -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- Babel for JSX -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-slate-50">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useMemo } = React;

    // ==== Supabase config ====
    const SUPABASE_URL = "https://wphylenqbjyskbpbbuax.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndwaHlsZW5xYmp5c2ticGJidWF4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTczNTQyNDMsImV4cCI6MjA3MjkzMDI0M30.qN68IhysCYgOYG4ZW3fYvAWbSTJihfttnRgrE2DHRyY";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Helpers
    const uuid = () => (crypto?.randomUUID ? crypto.randomUUID() : 'id-' + Math.random().toString(36).slice(2) + Date.now());
    const getMonthString = (date) => date.toLocaleString('en-US', { month: 'long', year: 'numeric' });
    const currentMonth = getMonthString(new Date());

    // ---------- Auth UI ----------
    const AuthPanel = () => {
      const [email, setEmail] = useState("");
      const [password, setPassword] = useState("");
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState("");

     const signUpOrIn = async (mode) => {
  setLoading(true);
  setError("");
  try {
    if (!email || !password) {
      setError("Please enter email and password.");
      return;
    }

    console.log("[Auth] starting", mode, email);

    if (mode === "signup") {
      const { error } = await supabase.auth.signUp({ email, password });
      if (error) throw error;
      alert("Account created. Now sign in.");
      return;
    }

    // SIGN IN
    const { data, error } = await supabase.auth.signInWithPassword({
      email,
      password,
    });
    if (error) throw error;

    console.log("[Auth] sign-in response:", data);

    // Verify we actually have a session and then reload the app state
    const { data: s } = await supabase.auth.getSession();
    if (s?.session) {
      console.log("[Auth] session present, reloading...");
      setError("Signed in but no session detected. Check Supabase Auth URL configuration.");
    }
  } catch (e) {
    console.error("[Auth] error:", e);
    setError(e?.message || "Failed to sign in.");
  } finally {
    setLoading(false);
  }
};


      return (
        <div className="min-h-screen flex items-center justify-center p-6">
          <div className="bg-white w-full max-w-md rounded-xl shadow-lg p-6">
            <h1 className="text-2xl font-bold text-slate-800 mb-4 text-center">Sign in to Household Sheet</h1>
            <p className="text-sm text-slate-600 mb-4 text-center">Use the same account on both devices.</p>
            <div className="space-y-3">
              <input className="w-full p-3 border border-slate-300 rounded-lg" type="email" placeholder="Email" value={email} onChange={(e)=>setEmail(e.target.value)} />
              <input className="w-full p-3 border border-slate-300 rounded-lg" type="password" placeholder="Password" value={password} onChange={(e)=>setPassword(e.target.value)} />
            </div>
            {error && <p className="text-red-600 mt-3 text-sm">{error}</p>}
            <div className="flex gap-3 mt-4">
              <button disabled={loading} onClick={()=>signUpOrIn('signin')} className="flex-1 p-3 bg-blue-600 text-white rounded-lg disabled:opacity-50">Sign In</button>
              <button disabled={loading} onClick={()=>signUpOrIn('signup')} className="p-3 px-4 bg-slate-200 rounded-lg disabled:opacity-50">Sign Up</button>
            </div>
          </div>
        </div>
      );
    };

    // ---------- Main App ----------
    const App = () => {
      const [session, setSession] = useState(null);
      const [months, setMonths] = useState([currentMonth]);
      const [selectedMonth, setSelectedMonth] = useState(currentMonth);

      const [income, setIncome] = useState([]);
      const [costs, setCosts] = useState([]);
      const [fixedCosts, setFixedCosts] = useState([]);
      const [fixedApplied, setFixedApplied] = useState(false); // kept for now, not used for disabling

      const [modal, setModal] = useState({ isOpen: false, type: null, title: '', message: '' });

      const getUserId = async () => {
        const { data: { session } } = await supabase.auth.getSession();
        return session?.user?.id || null;
      };
      // ---------- Main App ----------
const App = () => {
  const [session, setSession] = useState(null);
  // ... your other state

  // âœ… AUTH LISTENER (required)
  useEffect(() => {
    // get the current session on first load
    (async () => {
      const { data: { session } } = await supabase.auth.getSession();
      setSession(session || null);
    })();

    // subscribe to future auth changes (sign in / sign out / token refresh)
    const { data: { subscription } } = supabase.auth.onAuthStateChange((_event, sess) => {
      setSession(sess || null);
    });

    return () => subscription.unsubscribe();
  }, []);

      // Auth state
// Replace your "After login" effect with this:
useEffect(() => {
  if (!session) return;
  (async () => {
    const list = await loadMonths();

    // If the currently selected month isn't in the list, pick the newest that exists
    if (list.length && !list.includes(selectedMonth)) {
      setSelectedMonth(list[list.length - 1]); // newest available
    }
  })();
}, [session]);


      // After login, fetch months list
      useEffect(() => { if (session) loadMonths(); }, [session]);

      // Fetch fixed costs once logged in
      useEffect(() => {
        if (!session) return;
        (async () => {
          const { data } = await supabase
            .from('fixed_costs')
            .select('*')
            .order('created_at', { ascending: true });
          setFixedCosts(data || []);
        })();
      }, [session]);

      // Fetch entries for selected month
      useEffect(() => {
        if (!session) return;
        (async () => {
          const { data } = await supabase
            .from('entries')
            .select('*')
            .eq('month', selectedMonth)
            .order('created_at', { ascending: true });
          const inc = (data || []).filter(r => r.type === 'income');
          const cos = (data || []).filter(r => r.type === 'cost');
          setIncome(inc);
          setCosts(cos);

          const { data: flags } = await supabase
            .from('month_flags')
            .select('*')
            .eq('month', selectedMonth)
            .maybeSingle();
          setFixedApplied(!!flags?.fixed_costs_applied);
        })();
      }, [session, selectedMonth]);

      // Totals
      const totalIncome = useMemo(() => income.reduce((a,b)=> a + Number(b.amount||0), 0), [income]);
      const totalCosts  = useMemo(() => costs.reduce((a,b)=> a + Number(b.amount||0), 0), [costs]);
      const netBalance  = useMemo(() => totalIncome - totalCosts, [totalIncome, totalCosts]);

// Replace your existing loadMonths with this:
const loadMonths = async () => {
  try {
    const monthsSet = new Set();

    // entries months
    const { data: m1, error: e1 } = await supabase
      .from('entries')
      .select('month')
      .order('created_at', { ascending: true });

    if (e1) {
      console.error('loadMonths entries error:', e1);
    } else {
      (m1 || []).forEach(r => r?.month && monthsSet.add(r.month));
    }

    // month_flags months
    const { data: m2, error: e2 } = await supabase
      .from('month_flags')
      .select('month, created_at')
      .order('created_at', { ascending: true });

    if (e2) {
      console.error('loadMonths month_flags error:', e2);
    } else {
      (m2 || []).forEach(r => r?.month && monthsSet.add(r.month));
    }

    // Always include the current month label so the dropdown has it
    const currentLabel = getMonthString(new Date());
    monthsSet.add(currentLabel);

    const list = Array.from(monthsSet);
    list.sort((a, b) => {
      // sort by date so newest is last
      const da = new Date(`${a} 1`);
      const db = new Date(`${b} 1`);
      return da - db;
    });

    setMonths(list);
    return list;
  } catch (err) {
    console.error('loadMonths fatal:', err);
    return [];
  }
};


      const updateEntry = async (id, fields) => {
        const { data, error } = await supabase.from('entries').update(fields).eq('id', id).select().single();
        if (error) return;
        setIncome(prev => prev.map(i => i.id===id ? { ...i, ...data } : i));
        setCosts(prev => prev.map(c => c.id===id ? { ...c, ...data } : c));
      };

      const deleteEntry = async (id, type) => {
        const { error } = await supabase.from('entries').delete().eq('id', id);
        if (error) return;
        if (type === 'income') setIncome(prev => prev.filter(i => i.id !== id));
        else setCosts(prev => prev.filter(c => c.id !== id));
      };

      const addFixedCost = async ({ description, amount }) => {
        if (!description || !amount) return;
        const user_id = await getUserId();
        if (!user_id) { alert('Please sign in again'); return; }
        const payload = { id: uuid(), user_id, description, amount: Number(amount) };
        const { data, error } = await supabase.from('fixed_costs').insert(payload).select().single();
        if (error) {
          console.error('Fixed cost insert error:', error);
          alert('Error adding fixed cost: ' + (error.message || 'unknown'));
          return;
        }
        setFixedCosts(prev => [...prev, data]);
      };

      const deleteFixedCost = async (id) => {
        const { error } = await supabase.from('fixed_costs').delete().eq('id', id);
        if (error) return;
        setFixedCosts(prev => prev.filter(f => f.id !== id));
      };

      // Always enabled: refreshes fixed costs for the selected month
      const applyFixedCosts = async () => {
        if (fixedCosts.length === 0) {
          alert('No fixed costs defined yet');
          return;
        }

        const { data: u } = await supabase.auth.getUser();
        const user_id = u?.user?.id;
        if (!user_id) { alert('Please sign in again'); return; }

        // 1) Remove previously-applied fixed costs for this month
        const { error: delErr } = await supabase
          .from('entries')
          .delete()
          .eq('user_id', user_id)
          .eq('month', selectedMonth)
          .eq('is_fixed', true);
        if (delErr) {
          console.error('Delete old fixed rows error:', delErr);
          alert('Could not refresh fixed costs');
          return;
        }

        // 2) Insert fresh snapshot from fixed_costs
        const rows = fixedCosts.map(fc => ({
          id: uuid(),
          user_id,
          month: selectedMonth,
          type: 'cost',
          description: fc.description,
          amount: Number(fc.amount),
          is_fixed: true
        }));

        if (rows.length) {
          const { error: insErr } = await supabase.from('entries').insert(rows);
          if (insErr) {
            console.error('Insert fixed rows error:', insErr);
            alert('Could not apply fixed costs');
            return;
          }
        }

        // 3) Update UI list for this month
        setCosts(prev => {
          const keep = prev.filter(c => !c.is_fixed);
          return [...keep, ...rows];
        });
      };

      const addMonth = async (name) => {
        const n = (name || '').trim();
        if (!n) return;
        const user_id = await getUserId();
        if (!user_id) { alert('Please sign in again'); return; }
        const { error } = await supabase
          .from('month_flags')
          .upsert({ month: n, user_id, fixed_costs_applied: false })
          .select();
        if (error) {
          console.error('Add month error:', error);
          alert('Could not add month: ' + (error.message || 'unknown'));
          return;
        }
        await loadMonths();
        setSelectedMonth(n);
      };

      const signOut = async () => { await supabase.auth.signOut(); };

      if (!session) return <AuthPanel />;

      return (
        <div className="min-h-screen font-sans text-gray-800 p-4 sm:p-6 lg:p-8">
          {modal.isOpen && (
            <Modal type={modal.type} title={modal.title} message={modal.message}
              onClose={()=>setModal({ isOpen:false })} onSubmit={addMonth} />
          )}

          <div className="max-w-7xl mx-auto">
            <header className="mb-8">
              <div className="flex items-center justify-between">
                <h1 className="text-3xl sm:text-4xl font-bold text-slate-800">Income & Cost Sheet</h1>
                <button onClick={signOut} className="p-2 px-4 bg-slate-200 rounded-lg">Sign out</button>
              </div>
              <MonthNavigator
                months={months}
                selectedMonth={selectedMonth}
                onSelectMonth={setSelectedMonth}
                onAddMonth={()=> setModal({ isOpen:true, type:'prompt', title:'Add New Month', message:'Enter the month and year (e.g., October 2025):' })}
              />
            </header>

            <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
              <SummaryCard title="Total Income" amount={totalIncome} color="text-green-500" />
              <SummaryCard title="Total Costs" amount={totalCosts} color="text-red-500" />
              <SummaryCard title="Net Balance" amount={netBalance} color={netBalance >= 0 ? 'text-blue-500' : 'text-orange-500'} />
            </div>

            <FixedCostsManager
              fixedCosts={fixedCosts}
              onAdd={addFixedCost}
              onDelete={deleteFixedCost}
              onApply={applyFixedCosts}
              canApply={true}  /* always enabled */
            />

            <div className="grid grid-cols-1 lg:grid-cols-2 gap-8 mt-8">
              <TransactionSection title="Income" type="income" items={income}
                onAddItem={addEntry}
                onDeleteItem={(t,id)=>deleteEntry(id,'income')}
                onEditItem={(t,id,field,value)=>updateEntry(id, { [field]: field==='amount' ? Number(value)||0 : value })}
                total={totalIncome} color="green" />

              <TransactionSection title="Costs" type="costs" items={costs}
                onAddItem={(t, item)=>addEntry('cost', item)}
                onDeleteItem={(t,id)=>deleteEntry(id,'cost')}
                onEditItem={(t,id,field,value)=>updateEntry(id, { [field]: field==='amount' ? Number(value)||0 : value })}
                total={totalCosts} color="red" />
            </div>
          </div>
        </div>
      );
    };

    // ---------- Reusable UI ----------
    const Modal = ({ type, title, message, onClose, onSubmit }) => {
      const [inputValue, setInputValue] = useState('');
      const handleSubmit = (e) => { e.preventDefault(); if (type==='prompt' && onSubmit) onSubmit(inputValue); onClose(); };
      return (
        <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4">
          <div className="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md">
            <h2 className="text-2xl font-bold text-slate-800 mb-4">{title}</h2>
            <p className="text-slate-600 mb-6">{message}</p>
            <form onSubmit={handleSubmit}>
              {type==='prompt' && (
                <input type="text" value={inputValue} onChange={(e)=>setInputValue(e.target.value)}
                  className="w-full p-3 border border-slate-300 rounded-lg mb-4 focus:outline-none focus:ring-2 focus:ring-blue-400" required />
              )}
              <div className="flex justify-end gap-3">
                <button type="button" onClick={onClose} className="p-2 px-4 bg-slate-200 rounded-lg">Cancel</button>
                <button type="submit" className="p-2 px-4 bg-blue-500 text-white rounded-lg">{type==='prompt' ? 'Submit' : 'OK'}</button>
              </div>
            </form>
          </div>
        </div>
      );
    };

    const MonthNavigator = ({ months, selectedMonth, onSelectMonth, onAddMonth }) => (
      <div className="mt-4 flex flex-col sm:flex-row items-center justify-between gap-4 p-4 bg-white rounded-xl shadow-md">
        <div className="flex items-center gap-3">
          <label htmlFor="month-select" className="font-semibold text-slate-600">Current Month:</label>
          <select id="month-select" value={selectedMonth} onChange={(e)=>onSelectMonth(e.target.value)}
            className="p-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400">
            {months.map(m => <option key={m} value={m}>{m}</option>)}
          </select>
        </div>
        <button onClick={onAddMonth} className="p-2 px-4 bg-blue-500 text-white rounded-lg shadow-md hover:bg-blue-600 transition-transform hover:scale-105">+ Add Month</button>
      </div>
    );

    const FixedCostsManager = ({ fixedCosts, onAdd, onDelete, onApply, canApply }) => {
      const [description, setDescription] = useState("");
      const [amount, setAmount] = useState("");
      const handleAdd = (e) => { e.preventDefault(); onAdd({ description, amount }); setDescription(""); setAmount(""); };
      return (
        <div className="bg-white rounded-xl shadow-lg p-6">
          <h2 className="text-2xl font-bold text-slate-800 mb-4">Manage Fixed Costs</h2>
          <form onSubmit={handleAdd} className="flex flex-col sm:flex-row gap-3 mb-4">
            <input type="text" value={description} onChange={e=>setDescription(e.target.value)} placeholder="Description (e.g., Rent)" className="flex-grow p-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-400" required />
            <input type="number" value={amount} onChange={e=>setAmount(e.target.value)} placeholder="Amount" className="w-full sm:w-32 p-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-400" required min="0" step="0.01" />
            <button type="submit" className="p-3 bg-indigo-500 text-white rounded-lg shadow-md hover:bg-indigo-600 transition-transform hover:scale-105">Add Fixed Cost</button>
          </form>
          <ul className="space-y-2 mb-4">
            {fixedCosts.map(fc => (
              <li key={fc.id} className="flex justify-between items-center p-2 bg-slate-100 rounded-lg">
                <span>{fc.description} - ${Number(fc.amount).toLocaleString()}</span>
                <button onClick={()=>onDelete(fc.id)} className="text-slate-400 hover:text-red-500" title="Delete">
                  <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
              </li>
            ))}
          </ul>
          <button onClick={onApply} disabled={!canApply} className="w-full p-3 bg-emerald-500 text-white font-bold rounded-lg shadow-md hover:bg-emerald-600 disabled:bg-slate-300 disabled:cursor-not-allowed transition">
            {canApply ? 'Apply Fixed Costs to Current Month' : 'Fixed Costs Already Applied'}
          </button>
        </div>
      );
    };

    const SummaryCard = ({ title, amount, color }) => (
      <div className="bg-white p-6 rounded-xl shadow-md transition-transform hover:scale-105">
        <h2 className="text-lg font-semibold text-slate-600 mb-2">{title}</h2>
        <p className={`text-4xl font-bold ${color}`}>${Number(amount).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</p>
      </div>
    );

    const TransactionSection = ({ title, type, items, onAddItem, onDeleteItem, onEditItem, total, color }) => {
      const [newItem, setNewItem] = useState({ description: '', amount: '' });
      const headerColor = color === 'green' ? 'bg-green-500' : 'bg-red-500';
      const focusColor = color === 'green' ? 'focus:ring-green-400' : 'focus:ring-red-400';
      const buttonColor = color === 'green' ? 'bg-green-500 hover:bg-green-600' : 'bg-red-500 hover:bg-red-600';

      const handleSubmit = (e) => { e.preventDefault(); onAddItem(type, newItem); setNewItem({ description:'', amount:'' }); };

      return (
        <div className="bg-white rounded-xl shadow-lg overflow-hidden">
          <header className={`p-4 ${headerColor}`}><h2 className="text-2xl font-bold text-white">{title}</h2></header>
          <div className="p-6">
            <form onSubmit={handleSubmit} className="flex flex-col sm:flex-row gap-3 mb-6">
              <input type="text" name="description" value={newItem.description}
                onChange={(e)=>setNewItem(prev=>({ ...prev, description: e.target.value }))}
                placeholder="Description"
                className={`flex-grow p-3 border border-slate-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 ${focusColor}`} required />
              <input type="number" name="amount" value={newItem.amount}
                onChange={(e)=>setNewItem(prev=>({ ...prev, amount: e.target.value }))}
                placeholder="Amount"
                className={`w-full sm:w-32 p-3 border border-slate-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 ${focusColor}`} required min="0" step="0.01" />
              <button type="submit" className={`p-3 text-white font-semibold rounded-lg shadow-md transition-transform hover:scale-105 ${buttonColor}`}>Add</button>
            </form>

            <div className="overflow-x-auto">
              <table className="w-full text-left">
                <thead>
                  <tr className="border-b border-slate-200">
                    <th className="p-3 text-slate-600 font-semibold">Description</th>
                    <th className="p-3 text-slate-600 font-semibold text-right w-36">Amount</th>
                    <th className="p-3 text-center w-16"></th>
                  </tr>
                </thead>
                <tbody>
                  {items.length>0 ? items.map(item => (
                    <EditableRow key={item.id} item={item} type={type} onDeleteItem={onDeleteItem} onEditItem={onEditItem} focusColor={focusColor} />
                  )) : (
                    <tr><td colSpan="3" className="p-4 text-center text-slate-400">No items added yet.</td></tr>
                  )}
                </tbody>
                <tfoot>
                  <tr className="border-t-2 border-slate-300">
                    <td className="p-4 text-lg font-bold text-right">Total:</td>
                    <td className="p-4 text-lg font-bold text-right">${Number(total).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                    <td></td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>
        </div>
      );
    };

    const EditableRow = ({ item, type, onDeleteItem, onEditItem, focusColor }) => {
      const handleBlur = (field, e) => onEditItem(type, item.id, field, e.target.value);
      const handleKeyDown = (e) => { if (e.key === 'Enter') e.target.blur(); };
      return (
        <tr className="border-b border-slate-200 hover:bg-slate-50">
          <td className="p-3">
            <input type="text" defaultValue={item.description}
              onBlur={(e)=>handleBlur('description', e)} onKeyDown={handleKeyDown}
              className={`w-full bg-transparent p-1 rounded-md focus:bg-white focus:outline-none focus:ring-2 ${focusColor}`} />
          </td>
          <td className="p-3 text-right">
            <input type="number" defaultValue={item.amount}
              onBlur={(e)=>handleBlur('amount', e)} onKeyDown={handleKeyDown}
              className={`w-full bg-transparent text-right p-1 rounded-md focus:bg-white focus:outline-none focus:ring-2 ${focusColor}`} min="0" step="0.01" />
          </td>
          <td className="p-3 text-center">
            <button onClick={()=>onDeleteItem(type, item.id)} className="text-slate-400 hover:text-red-500" aria-label="Delete item" title="Delete">
              <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
            </button>
          </td>
        </tr>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>



